#=======================================================================================================================
# Main options
#=======================================================================================================================
# =C-b= is a pain to use when in copy mode as to scroll-up a full screen, we've to press =C-b= twice since upon the first press it's interpreted as a prefix.
# Thus change it to =C-Space=. =C-a= is the default prefix used by screen but it collides with emacs readline
unbind C-b
unbind C-Space
unbind -T copy-mode 'C-Space'
set -g prefix C-Space

# Disable wait for escape sequence to enable faster command sequence
set -sg escape-time 0
set -sg repeat-time 600

# vi-mode for copy-paste
setw -g mode-keys vi

# Set the default terminal mode to 256color mode
set -g default-terminal "tmux-256color"

# Sane scrolling (http://superuser.com/a/314620)
# 24-bit color support (https://www.reddit.com/r/emacs/comments/8ndm2x/gnu_emacs_261_24bit_colors_suckless_st_terminal/dzwh4vv/)
set-option -sa terminal-overrides ",xterm*:Tc"

set -g history-limit 10000

# To allow =FocusGained= and =FocusLost= autocmds to work in vim (https://github.com/tmux-plugins/vim-tmux-focus-events)
set -g focus-events on

# Use emacs keybindings in tmux's command prompt. Emacs is the default but if I don't set this explicitly, it gets set to vi as my $VISUAL and $EDITOR are set to gvim and vim respectively.
set -g status-keys emacs

# Increase the time between refresh (Default=15)
set -g status-interval 60

# Enable activity alerts
setw -g monitor-activity on


#=======================================================================================================================
# Pane configuration
#=======================================================================================================================
# Set the starting pane index to 1
setw -g pane-base-index 1


#=======================================================================================================================
# Window configuration
#=======================================================================================================================
# Set the starting window index to 1
set -g base-index 1

# Blink the pane tab in case of any activity
setw -g window-status-activity-style blink


#=======================================================================================================================
# Bindings
#=======================================================================================================================
# I use as many as vim's bindings as possible. Since I use evil in emacs I only end up having to learn one set of
# bindings that I can use everywhere. Also, since Tmux uses some lowercase and uppercase characters by default,
# I use Ctrl and Alt(Meta) as modifiers for mine to avoid clobbering the default bindings as much as possible

# '-r' indicates that the binding is repeatable i.e. the prefix need not be pressed again to use it

# Reload tmux.conf is defined at the end as tmux-resurrect clobbers the binding I want to use

# Allows fast scrolling through a pane's history. -e specifies that scrolling to the bottom exits copy-mode
bind PageUp copy-mode -eu

# Copy-Paste
# Use =prefix+]= to paste. =prefix+p= would be the logical choice for paste but it's better used in next/previous context
bind -T copy-mode-vi 'v'   send -X begin-selection
bind -T copy-mode-vi 'V'   send -X select-line
bind -T copy-mode-vi 'C-v' send -X rectangle-toggle
bind -T copy-mode-vi 'y'   send -X copy-selection-and-cancel
bind -T copy-mode-vi 'Y'   send -X copy-pipe-and-cancel


#=======================================================================================================================
# Pane bindings
#=======================================================================================================================
# Pane and Window bindings use similar suffix for related behavior eg. 'x' to kill
# I differentiate between them using Ctrl as modifier for panes and Meta/Alt for windows

# Use h-j-k-l to navigate (similar to vim)
# I'd like to use -r (repeatable) option for these. However, I use C-l a lot to clear the screen and the two conflict
bind C-h select-pane -L
bind C-j select-pane -D
bind C-k select-pane -U
bind C-l select-pane -R
# l is used to jump to last active window by default which gets confusing if I accidentally press 'l' instead of 'C-l'
# so unbind that to avoid confusion
unbind l

# Kill pane without confirmation. The default binding asks for confirmation
bind -N "Kill current pane" C-x kill-pane
bind -N "Kill other panes"  C-o kill-pane -a

# Create Panes. Use vim's bindings to create splits here. It's more intuitive
# bind C-s is defined at the end as tmux-resurrect clobbers it
bind C-v split-window -h -c '#{pane_current_path}'

# Goto Pane
bind C-g display-panes
bind -N "Select previously active pane" C-w last-pane


#=======================================================================================================================
# Window bindings
#=======================================================================================================================
# Pane and Window bindings use similar suffix for related behavior eg. 'x' to kill
# I differentiate between them using Ctrl as modifier for panes and Meta/Alt for windows

bind M-8 run-shell 'bash -ci "tmuxw select-layout work-lp" > /dev/null'
bind M-9 run-shell 'bash -ci "tmuxw select-layout work-pc" > /dev/null'

bind -N "Create a new window" M-c new-window

# Tmux uses n/p to go to next/previous window. Make control versions of it
bind -rN "Next window"     M-n next-window
bind -rN "Previous window" M-p previous-window

# Kill windows
bind -N "Kill current window" M-x kill-window
bind -N "Kill other windows"  M-o kill-window -a

# Goto last active window
bind -N "Select previously active window" M-w last-window


#=======================================================================================================================
# Tmux Plugins
#=======================================================================================================================
# Plugin manager
set -g @plugin 'tmux-plugins/tpm'
bind C-t switch-client -Ttmux-plugins-table

# tmux-resurrect session save/restore
set -g @plugin 'tmux-plugins/tmux-resurrect'
# set -g @plugin 'tmux-plugins/tmux-continuum'
# set -g @continuum-restore 'on'

# Catpuccin Theme
set -g @plugin 'kshenoy/catppuccin-tmux'
set -g @catppuccin_flavour 'frappe' # latte, frappe, macchiato or mocha
set -g @plugin 'laktak/extrakto'

# Initialize TMUX plugin manager (keep this line at the very bottom of tmux.conf)
run '~/.config/tmux/plugins/tpm/tpm'

# By default, it uses 'r' and 's' in the global namespace which collides with other bindings
# So rebinding them to what I actually want to use it for
bind -N "Reload config" C-r source-file ~/.config/tmux/tmux.conf \; refresh-client -S\; display-message " Config reloaded"
bind C-s split-window -v -c '#{pane_current_path}'
# I can change the bindings by setting '@resurrect-save' and '@resurrect-restore' but it doesn't allow putting the
# bindings in client key tables today so I have to explicitly bind it to the scripts
bind -Ttmux-plugins-table s run-shell '~/.config/tmux/plugins/tmux-resurrect/scripts/save.sh'
bind -Ttmux-plugins-table r run-shell '~/.config/tmux/plugins/tmux-resurrect/scripts/restore.sh'
